<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè™ Mini Mart POS System</title>
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .user-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            color: #4f46e5;
            display: none;
        }

        .user-info.show {
            display: block;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-button {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            text-decoration: none;
            display: inline-block;
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .tab-button.active {
            background: linear-gradient(45deg, #059669, #047857);
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .tab-button.logout {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .tab-button.logout:hover {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        /* Login Content */
        .login-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 500px;
            margin: 50px auto;
            animation: fadeIn 0.5s ease;
        }

        .login-content h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2d3748;
        }

        /* Connection Status */
        .connection-status {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .connection-status.connecting {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .connection-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* POS Interface */
        .pos-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 70vh;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 12px;
            overflow-y: auto;
            max-height: 100%;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #4f46e5;
        }

        .product-card.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .product-card.out-of-stock:hover {
            transform: none;
            border-color: transparent;
        }

        .product-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .product-price {
            color: #059669;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Cart Panel */
        .cart-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .cart-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .cart-item:hover {
            background: rgba(79, 70, 229, 0.05);
            border-radius: 8px;
            padding: 12px 8px;
        }

        .item-info {
            flex: 1;
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            background: #4f46e5;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .qty-btn:hover {
            background: #3730a3;
            transform: scale(1.1);
        }

        .cart-total {
            background: linear-gradient(45deg, #1f2937, #374151);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .total-amount {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .checkout-btn,
        .btn {
            background: linear-gradient(45deg, #059669, #047857);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .checkout-btn:hover,
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: linear-gradient(45deg, #1f2937, #374151);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table tr:hover {
            background: rgba(79, 70, 229, 0.05);
        }

        /* Reports */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #6b7280;
        }

        /* Search Box */
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            margin-bottom: 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, #059669, #047857);
        }

        .notification.error {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
        }

        .notification.info {
            background: linear-gradient(45deg, #2563eb, #1d4ed8);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .pos-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .product-grid {
                height: 300px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }

            .tab-button {
                width: 200px;
                margin-bottom: 5px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <div class="container">
        <div class="header">
            <h1>üè™ Mini Mart POS System</h1>

            <!-- User Info (shown when logged in) -->
            <div class="user-info" id="userInfo">
                Welcome back, <span id="currentUserEmail"></span>
                <br>
                <small>Session active since <span id="loginTime"></span></small>
            </div>

            <div class="nav-tabs" id="navTabs">
                <!-- Navigation will be updated by JavaScript based on login status -->
            </div>
        </div>

        <!-- Login Tab -->
        <div id="login" class="tab-content active">
            <div class="login-content">
                <h2>üîí Login to POS System</h2>

                <!-- Connection Status -->
                <div class="connection-status connecting" id="connectionStatus">
                    <strong>üîÑ Checking connection...</strong><br>
                    Testing API connection to <code id="apiUrl">http://localhost:8080</code>
                </div>

                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Email Address</label>
                        <input type="email" id="username" class="form-control" value="admin@gmail.com" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="form-control" value="admin123" required>
                    </div>
                    <button type="submit" class="btn" id="loginBtn">
                        üîê Login to System
                    </button>
                </form>

                <div style="margin-top: 20px; text-align: center;">
                    <button type="button" class="btn" onclick="testConnection()"
                        style="background: linear-gradient(45deg, #2563eb, #1d4ed8);">
                        üîß Test API Connection
                    </button>
                </div>
            </div>
        </div>

        <!-- POS Tab -->
        <div id="pos" class="tab-content">
            <div class="pos-layout">
                <div>
                    <input type="text" class="search-box" id="productSearch" placeholder="üîç Search products..."
                        oninput="searchProducts(this.value)">
                    <div class="product-grid" id="productGrid">
                        <div class="loading">Loading products...</div>
                    </div>
                </div>

                <div class="cart-panel">
                    <div class="cart-header">
                        <h2>üõí Current Sale</h2>
                    </div>
                    <div class="cart-items" id="cartItems">
                        <div style="text-align: center; color: #6b7280; padding: 20px;">Cart is empty</div>
                    </div>
                    <div class="cart-total">
                        <div class="total-amount" id="totalAmount">$0.00</div>
                        <div>Total Amount</div>
                    </div>
                    <button class="checkout-btn" onclick="checkout()" disabled>üí∞ Checkout</button>
                    <button class="btn btn-danger" onclick="clearCart()">üóëÔ∏è Clear Cart</button>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="form-grid">
                <div>
                    <h2>‚ûï Add Product to Inventory</h2>
                    <form id="inventoryForm" onsubmit="addInventoryProduct(event)">
                        <div class="form-group">
                            <label for="inventoryStockProduct">Stock Product</label>
                            <select id="inventoryStockProduct" class="form-control" required>
                                <option value="">Select a stock product...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inventorySalePrice">Sale Price ($)</label>
                            <input type="number" id="inventorySalePrice" class="form-control" step="0.01" min="0"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="inventorySaleQuantity">Sale Quantity</label>
                            <input type="number" id="inventorySaleQuantity" class="form-control" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="inventoryDiscount">Discount (0-1)</label>
                            <input type="number" id="inventoryDiscount" class="form-control" step="0.01" min="0" max="1"
                                value="0">
                        </div>
                        <button type="submit" class="btn">Add to Inventory</button>
                    </form>
                </div>
                <div>
                    <h2>üìã Inventory Products</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Sale Price</th>
                                <th>Discount</th>
                                <th>Final Price</th>
                                <th>Quantity</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <tr>
                                <td colspan="7" class="loading">Loading inventory...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stock Tab -->
        <div id="stock" class="tab-content">
            <div class="form-grid">
                <div>
                    <h2>üì• Add Stock Product</h2>
                    <form id="stockForm" onsubmit="addStockProduct(event)">
                        <div class="form-group">
                            <label for="stockProductName">Product Name</label>
                            <input type="text" id="stockProductName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="stockBasePrice">Base Price ($)</label>
                            <input type="number" id="stockBasePrice" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="stockQuantity">Quantity</label>
                            <input type="number" id="stockQuantity" class="form-control" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="stockCategory">Category</label>
                            <select id="stockCategory" class="form-control" required>
                                <option value="">Select category...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Add to Stock</button>
                    </form>
                </div>
                <div>
                    <h2>üìã Stock Products</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Base Price</th>
                                <th>Quantity</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stockTable">
                            <tr>
                                <td colspan="5" class="loading">Loading stock...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todaySales">$0</div>
                    <div class="stat-label">Today's Sales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Transactions Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topProduct">-</div>
                    <div class="stat-label">Top Selling Product</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lowStock">0</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProfit">$0</div>
                    <div class="stat-label">Today's Profit</div>
                </div>
            </div>
            <h2>üìà Recent Transactions</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Payment Method</th>
                    </tr>
                </thead>
                <tbody id="transactionTable">
                    <tr>
                        <td colspan="4" class="loading">Loading transactions...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="form-grid">
                <div>
                    <h2>üè™ Store Information</h2>
                    <form id="storeForm" onsubmit="saveStoreSettings(event)">
                        <div class="form-group">
                            <label for="storeName">Store Name</label>
                            <input type="text" id="storeName" class="form-control" value="Mini Mart">
                        </div>
                        <div class="form-group">
                            <label for="storeAddress">Address</label>
                            <input type="text" id="storeAddress" class="form-control"
                                value="123 Main Street, City, State 12345">
                        </div>
                        <div class="form-group">
                            <label for="storePhone">Phone</label>
                            <input type="tel" id="storePhone" class="form-control">
                        </div>
                        <button type="submit" class="btn">Save Settings</button>
                    </form>
                </div>
                <div>
                    <h2>üí∞ Tax & Payment Settings</h2>
                    <form id="paymentForm" onsubmit="updatePaymentSettings(event)">
                        <div class="form-group">
                            <label for="taxRate">Tax Rate (%)</label>
                            <input type="number" id="taxRate" class="form-control" step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="currency">Currency</label>
                            <select id="currency" class="form-control">
                                <option value="USD">USD ($)</option>
                                <option value="EUR">EUR (‚Ç¨)</option>
                                <option value="GBP">GBP (¬£)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lowStockAlert">Low Stock Alert</label>
                            <input type="number" id="lowStockAlert" class="form-control" min="0" value="10">
                        </div>
                        <button type="submit" class="btn">Update Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>üí≥ Complete Payment</h2>
            <div class="form-group">
                <label for="paymentMethod">Payment Method</label>
                <select id="paymentMethod" class="form-control">
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="Mobile Payment">Mobile Payment</option>
                </select>
            </div>
            <div class="form-group">
                <label for="amountReceived">Amount Received ($)</label>
                <input type="number" id="amountReceived" class="form-control" step="0.01" min="0">
            </div>
            <div class="cart-total">
                <div>Total: $<span id="modalTotal">0.00</span></div>
                <div>Change: $<span id="changeAmount">0.00</span></div>
            </div>
            <button class="checkout-btn" onclick="completeSale()">Complete Sale</button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            baseURL: 'http://localhost:8080/api/v1',
            endpoints: {
                login: '/auth/login',
                categories: '/categories',
                stockProducts: '/stock/products',
                stockProductsAvailable: '/stock/products/available',
                inventoryProducts: '/inventory/products',
                purchases: '/product/purchases',
                dailyReport: '/reports/daily-summary'
            }
        };

        // Application State
        let authToken = localStorage.getItem('authToken') || null;
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let loginTime = localStorage.getItem('loginTime') || null;
        let categories = [];
        let stockProducts = [];
        let inventoryProducts = [];
        let cart = [];
        let transactions = [];
        let settings = {
            storeName: "Mini Mart",
            storeAddress: "123 Main Street, City, State 12345",
            storePhone: "",
            taxRate: 0,
            currency: "USD",
            lowStockAlert: 10
        };

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;

            const icons = {
                connecting: 'üîÑ',
                connected: '‚úÖ',
                error: '‚ùå'
            };

            statusElement.innerHTML = `<strong>${icons[status]} ${message}</strong><br>API Server: <code>${API_CONFIG.baseURL}</code>`;
        }

        // Enhanced API Service Class
        class ApiService {
            static async request(endpoint, options = {}) {
                const url = `${API_CONFIG.baseURL}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${String(authToken).trim()}` }),
                        ...options.headers
                    },
                    ...options
                };

                try {
                    console.log('API Request:', url);
                    const response = await fetch(url, config);

                    if (!response.ok) {
                        if (response.status === 401) {
                            this.logout();
                            showNotification('Session expired. Please login again.', 'error');
                            showTab('login');
                            throw new Error('Authentication required');
                        }
                        const errorText = await response.text();
                        throw new Error(`API Error: ${response.status} - ${errorText}`);
                    }

                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return await response.json();
                    } else {
                        return await response.text();
                    }
                } catch (error) {
                    console.error('API Request failed:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('Cannot connect to API server. Please check if the server is running.');
                    }
                    throw error;
                }
            }

            static async login(email, password) {
                const response = await this.request(API_CONFIG.endpoints.login, {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                console.log('Login response:', response);

                let token = null;
                if (response.data && response.data.token) {
                    token = response.data.token;
                } else if (response.data && typeof response.data === 'string') {
                    token = response.data;
                } else {
                    token = response.token || response.accessToken || response.jwt || response.authToken;
                }

                if (token) {
                    authToken = token;
                    currentUser = { email };
                    loginTime = new Date().toISOString();

                    // Store in localStorage for persistence
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('loginTime', loginTime);

                    console.log('Login successful, token stored');
                    return response;
                }

                throw new Error('No authentication token received from server');
            }

            static logout() {
                authToken = null;
                currentUser = null;
                loginTime = null;

                // Clear localStorage
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('loginTime');

                cart = [];
                updateCartDisplay();
            }

            // API Methods
            static async getCategories() {
                return await this.request(API_CONFIG.endpoints.categories);
            }

            static async getStockProducts() {
                return await this.request(API_CONFIG.endpoints.stockProducts);
            }

            static async getAvailableStockProducts() {
                return await this.request(API_CONFIG.endpoints.stockProductsAvailable);
            }

            static async createStockProduct(productData) {
                return await this.request(API_CONFIG.endpoints.stockProducts, {
                    method: 'POST',
                    body: JSON.stringify(productData)
                });
            }

            static async updateStockProduct(id, productData) {
                return await this.request(`${API_CONFIG.endpoints.stockProducts}/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(productData)
                });
            }

            static async deleteStockProduct(id) {
                return await this.request(`${API_CONFIG.endpoints.stockProducts}/${id}`, {
                    method: 'DELETE'
                });
            }

            static async getInventoryProducts() {
                return await this.request(API_CONFIG.endpoints.inventoryProducts);
            }

            static async createInventoryProduct(productData) {
                return await this.request(API_CONFIG.endpoints.inventoryProducts, {
                    method: 'POST',
                    body: JSON.stringify(productData)
                });
            }

            static async updateInventoryProduct(id, productData) {
                return await this.request(`${API_CONFIG.endpoints.inventoryProducts}/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(productData)
                });
            }

            static async returnInventoryToStock(id) {
                return await this.request(`${API_CONFIG.endpoints.inventoryProducts}/return-to-stock/${id}`, {
                    method: 'DELETE'
                });
            }

            static async createPurchase(purchaseData) {
                return await this.request(API_CONFIG.endpoints.purchases, {
                    method: 'POST',
                    body: JSON.stringify(purchaseData)
                });
            }

            static async getDailyReport() {
                return await this.request(API_CONFIG.endpoints.dailyReport);
            }
        }

        // Tab Management with Dynamic Login State
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // If user is not logged in and trying to access protected tabs
            if (!authToken && tabName !== 'login') {
                showNotification('Please login to access this feature', 'error');
                tabName = 'login';
            }

            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Update navigation
            updateNavigation(tabName);

            // Load data for specific tabs
            if (tabName === 'reports' && authToken) {
                updateReports();
            }

            // Show user info when logged in
            updateUserInfo();
        }

        function updateNavigation(activeTab = null) {
            const navTabs = document.getElementById('navTabs');
            if (!navTabs) return;

            navTabs.innerHTML = '';

            if (authToken) {
                // User is logged in - show full navigation
                const tabs = [
                    { id: 'pos', icon: 'üí≥', label: 'Point of Sale' },
                    { id: 'inventory', icon: 'üì¶', label: 'Inventory' },
                    { id: 'stock', icon: 'üì•', label: 'Stock' },
                    { id: 'reports', icon: 'üìä', label: 'Reports' },
                    { id: 'settings', icon: '‚öôÔ∏è', label: 'Settings' }
                ];

                tabs.forEach(tab => {
                    const button = document.createElement('button');
                    button.className = `tab-button ${activeTab === tab.id ? 'active' : ''}`;
                    button.textContent = `${tab.icon} ${tab.label}`;
                    button.onclick = () => showTab(tab.id);
                    navTabs.appendChild(button);
                });

                // Add logout button
                const logoutButton = document.createElement('button');
                logoutButton.className = 'tab-button logout';
                logoutButton.textContent = 'üö™ Logout';
                logoutButton.onclick = logout;
                navTabs.appendChild(logoutButton);

            } else {
                // User is not logged in - only show login
                const loginButton = document.createElement('button');
                loginButton.className = 'tab-button active';
                loginButton.textContent = 'üîí Login Required';
                loginButton.onclick = () => showTab('login');
                navTabs.appendChild(loginButton);
            }
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            const currentUserEmail = document.getElementById('currentUserEmail');
            const loginTimeElement = document.getElementById('loginTime');

            if (authToken && currentUser) {
                userInfo.classList.add('show');
                currentUserEmail.textContent = currentUser.email;
                if (loginTime) {
                    loginTimeElement.textContent = new Date(loginTime).toLocaleString();
                }
            } else {
                userInfo.classList.remove('show');
            }
        }

        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'üîÑ Logging in...';
                showLoading(true);

                console.log('Attempting login...');
                await ApiService.login(email, password);

                updateConnectionStatus('connected', 'Successfully connected and authenticated');
                showNotification('Login successful! Welcome to the POS system.', 'success');

                // Initialize data and switch to POS
                await initializeData();
                showTab('pos');

            } catch (error) {
                console.error('Login error:', error);
                updateConnectionStatus('error', 'Login failed');
                showNotification('Login failed: ' + error.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîê Login to System';
                showLoading(false);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                ApiService.logout();
                showNotification('Logged out successfully', 'info');
                showTab('login');

                // Reset connection status
                updateConnectionStatus('connecting', 'Checking connection...');
                testConnection();
            }
        }

        // Connection Testing
        async function testConnection() {
            try {
                updateConnectionStatus('connecting', 'Testing API connection...');

                // Test login endpoint directly (most reliable)
                const response = await fetch(API_CONFIG.baseURL + API_CONFIG.endpoints.login, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: "test", password: "test" })
                });

                // Any response (even 400/401) means server is up
                if (response.status === 400 || response.status === 401 || response.status === 403) {
                    updateConnectionStatus('connected', 'API server is online (login endpoint available)');
                    showNotification('‚úÖ API connection successful', 'success');
                } else if (response.ok) {
                    updateConnectionStatus('connected', 'API server is online and ready');
                    showNotification('‚úÖ API connection successful', 'success');
                } else {
                    throw new Error(`Unexpected response: ${response.status}`);
                }

            } catch (error) {
                updateConnectionStatus('error', 'Cannot connect to API server');
                showNotification('‚ùå API connection failed. Please check if the server is running.', 'error');
            }
        }
        // Data Initialization
        async function initializeData() {
            if (!authToken) {
                console.log('No auth token, skipping data initialization');
                return;
            }

            try {
                showLoading(true);
                showNotification('Loading system data...', 'info');

                const [categoriesResponse, stockResponse, inventoryResponse] = await Promise.all([
                    ApiService.getCategories().catch(e => ({ data: { item: [] } })),
                    ApiService.getStockProducts().catch(e => ({ data: { item: [] } })),
                    ApiService.getInventoryProducts().catch(e => ({ data: { item: [] } }))
                ]);

                console.log('API responses received');

                // Handle API response format
                categories = categoriesResponse.data?.item || categoriesResponse.data || categoriesResponse || [];
                stockProducts = stockResponse.data?.item || stockResponse.data || stockResponse || [];
                inventoryProducts = inventoryResponse.data?.item || inventoryResponse.data || inventoryResponse || [];

                // Ensure arrays
                if (!Array.isArray(categories)) categories = [];
                if (!Array.isArray(stockProducts)) stockProducts = [];
                if (!Array.isArray(inventoryProducts)) inventoryProducts = [];

                console.log('Data loaded:', {
                    categories: categories.length,
                    stockProducts: stockProducts.length,
                    inventoryProducts: inventoryProducts.length
                });

                // Update UI
                updateCategoryDropdowns();
                updateProductGrid();
                updateInventoryTable();
                updateStockTable();

                showNotification('System data loaded successfully', 'success');

            } catch (error) {
                console.error('Failed to initialize data:', error);
                showNotification('Failed to load system data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Product Grid Management
        function updateProductGrid(productsToShow = inventoryProducts) {
            const grid = document.getElementById('productGrid');
            if (!grid) return;

            grid.innerHTML = '';

            if (productsToShow.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">No products available in inventory</div>';
                return;
            }

            productsToShow.forEach(product => {
                const productCard = document.createElement('div');
                const isOutOfStock = (product.saleQuantity || 0) <= 0;

                productCard.className = `product-card ${isOutOfStock ? 'out-of-stock' : ''}`;
                productCard.onclick = isOutOfStock ? null : () => addToCart(product);

                const finalPrice = product.salePrice * (1 - (product.discount || 0));

                productCard.innerHTML = `
                    <div class="product-name">${product.name || 'Unknown Product'}</div>
                    <div class="product-price">${finalPrice.toFixed(2)}</div>
                    ${product.discount > 0 ? `<div style="font-size: 0.8rem; color: #dc2626; text-decoration: line-through;">${product.salePrice.toFixed(2)}</div>` : ''}
                    <div style="font-size: 0.8rem; color: ${isOutOfStock ? '#dc2626' : '#6b7280'}; margin-top: 5px;">
                        ${isOutOfStock ? 'Out of Stock' : `Stock: ${product.saleQuantity}`}
                    </div>
                `;

                grid.appendChild(productCard);
            });
        }

        function searchProducts(query) {
            const filtered = inventoryProducts.filter(product => {
                const name = product.name || '';
                const category = product.category?.name || '';
                return name.toLowerCase().includes(query.toLowerCase()) ||
                    category.toLowerCase().includes(query.toLowerCase());
            });
            updateProductGrid(filtered);
        }

        // Cart Management
        function addToCart(product) {
            const availableStock = product.saleQuantity || 0;

            if (availableStock <= 0) {
                showNotification('Product is out of stock!', 'error');
                return;
            }

            const existingItem = cart.find(item => item.id === product.id);

            if (existingItem) {
                if (existingItem.quantity < availableStock) {
                    existingItem.quantity++;
                    showNotification(`${product.name} quantity updated`, 'success');
                } else {
                    showNotification('Not enough stock available!', 'error');
                    return;
                }
            } else {
                const finalPrice = product.salePrice * (1 - (product.discount || 0));
                const productName = product.name || 'Unknown Product';

                cart.push({
                    id: product.id,
                    productInventoryId: product.id,
                    name: productName,
                    price: finalPrice,
                    originalPrice: product.salePrice,
                    discount: product.discount || 0,
                    quantity: 1,
                    maxStock: availableStock
                });

                showNotification(`${productName} added to cart`, 'success');
            }

            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const totalAmount = document.getElementById('totalAmount');
            const checkoutBtn = document.querySelector('.checkout-btn');

            if (!cartItems || !totalAmount) return;

            if (cart.length === 0) {
                cartItems.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">Cart is empty</div>';
                totalAmount.textContent = '$0.00';
                if (checkoutBtn) checkoutBtn.disabled = true;
                return;
            }

            let total = 0;
            cartItems.innerHTML = '';

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="item-info">
                        <div style="font-weight: 600;">${item.name}</div>
                        <div style="color: #6b7280; font-size: 0.9rem;">${item.price.toFixed(2)} x ${item.quantity} = ${itemTotal.toFixed(2)}</div>
                    </div>
                    <div class="item-controls">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <span style="margin: 0 10px; font-weight: 600;">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                        <button class="qty-btn" onclick="removeFromCart(${item.id})" style="background: #dc2626; margin-left: 10px;">√ó</button>
                    </div>
                `;

                cartItems.appendChild(cartItem);
            });

            // Add tax
            const tax = total * (settings.taxRate / 100);
            const totalWithTax = total + tax;

            totalAmount.textContent = `${totalWithTax.toFixed(2)}`;
            if (checkoutBtn) checkoutBtn.disabled = false;
        }

        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);

            if (item) {
                const newQuantity = item.quantity + change;

                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity <= item.maxStock) {
                    item.quantity = newQuantity;
                    updateCartDisplay();
                } else {
                    showNotification('Not enough stock available!', 'error');
                }
            }
        }

        function removeFromCart(productId) {
            const item = cart.find(item => item.id === productId);
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
            if (item) {
                showNotification(`${item.name} removed from cart`, 'info');
            }
        }

        function clearCart() {
            if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
                cart = [];
                updateCartDisplay();
                showNotification('Cart cleared', 'info');
            }
        }

        // Checkout Functions
        function checkout() {
            if (cart.length === 0) {
                showNotification('Cart is empty!', 'error');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = total * (settings.taxRate / 100);
            const totalWithTax = total + tax;

            document.getElementById('modalTotal').textContent = totalWithTax.toFixed(2);
            document.getElementById('amountReceived').value = totalWithTax.toFixed(2);
            document.getElementById('changeAmount').textContent = '0.00';
            document.getElementById('checkoutModal').style.display = 'block';
        }

        async function completeSale() {
            const total = parseFloat(document.getElementById('modalTotal').textContent);
            const received = parseFloat(document.getElementById('amountReceived').value);
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (received < total) {
                showNotification('Insufficient payment amount!', 'error');
                return;
            }

            try {
                showLoading(true);

                const purchaseData = {
                    items: cart.map(item => ({
                        productInventoryId: item.productInventoryId,
                        quantity: item.quantity
                    }))
                };

                await ApiService.createPurchase(purchaseData);

                const change = received - total;

                // Add to local transactions
                transactions.push({
                    time: new Date().toLocaleString(),
                    items: cart.length,
                    total: total,
                    paymentMethod: paymentMethod,
                    products: [...cart]
                });

                // Clear cart and close modal
                clearCart();
                closeModal();

                // Refresh data
                await initializeData();

                showNotification(`Sale completed! Change: ${change.toFixed(2)}`, 'success');

            } catch (error) {
                console.error('Purchase failed:', error);
                showNotification('Sale failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeModal() {
            const modal = document.getElementById('checkoutModal');
            if (modal) modal.style.display = 'none';
        }

        // Stock Product Management
        async function addStockProduct(event) {
            event.preventDefault();

            const name = document.getElementById('stockProductName').value;
            const basePrice = parseFloat(document.getElementById('stockBasePrice').value);
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const categoryId = parseInt(document.getElementById('stockCategory').value);

            const productData = {
                name,
                description: `Added on ${new Date().toLocaleDateString()}`,
                basePrice,
                quantity,
                categoryId
            };

            try {
                showLoading(true);
                await ApiService.createStockProduct(productData);

                document.getElementById('stockForm').reset();
                await initializeData();

                showNotification('Product added to stock successfully!', 'success');
            } catch (error) {
                showNotification('Failed to add product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editStockProduct(id) {
            const product = stockProducts.find(p => p.id === id);
            if (!product) return;

            const newName = prompt('Enter new name:', product.name);
            const newBasePrice = prompt('Enter new base price:', product.basePrice);
            const newQuantity = prompt('Enter new quantity:', product.quantity);

            if (newName && newBasePrice && newQuantity) {
                const updateData = {
                    name: newName,
                    description: product.description,
                    basePrice: parseFloat(newBasePrice),
                    quantity: parseInt(newQuantity),
                    categoryId: product.categoryId
                };

                try {
                    showLoading(true);
                    await ApiService.updateStockProduct(id, updateData);
                    await initializeData();
                    showNotification('Stock product updated successfully!', 'success');
                } catch (error) {
                    showNotification('Failed to update product: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        async function deleteStockProduct(id) {
            if (!confirm('Are you sure you want to delete this stock product?')) return;

            try {
                showLoading(true);
                await ApiService.deleteStockProduct(id);
                await initializeData();
                showNotification('Stock product deleted successfully!', 'success');
            } catch (error) {
                showNotification('Failed to delete product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Inventory Product Management
        async function addInventoryProduct(event) {
            event.preventDefault();

            const stockProductId = parseInt(document.getElementById('inventoryStockProduct').value);
            const salePrice = parseFloat(document.getElementById('inventorySalePrice').value);
            const saleQuantity = parseInt(document.getElementById('inventorySaleQuantity').value);
            const discount = parseFloat(document.getElementById('inventoryDiscount').value) || 0;

            const productData = {
                stockProductId,
                salePrice,
                saleQuantity,
                discount
            };

            try {
                showLoading(true);
                await ApiService.createInventoryProduct(productData);

                document.getElementById('inventoryForm').reset();
                await initializeData();

                showNotification('Product added to inventory successfully!', 'success');
            } catch (error) {
                showNotification('Failed to add to inventory: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editInventoryProduct(id) {
            const product = inventoryProducts.find(p => p.id === id);
            if (!product) return;

            const newSalePrice = prompt('Enter new sale price:', product.salePrice);
            const newSaleQuantity = prompt('Enter new sale quantity:', product.saleQuantity);
            const newDiscount = prompt('Enter new discount (0-1):', product.discount || 0);

            if (newSalePrice && newSaleQuantity && newDiscount !== null) {
                const updateData = {
                    stockProductId: product.stockProductId,
                    salePrice: parseFloat(newSalePrice),
                    saleQuantity: parseInt(newSaleQuantity),
                    discount: parseFloat(newDiscount)
                };

                try {
                    showLoading(true);
                    await ApiService.updateInventoryProduct(id, updateData);
                    await initializeData();
                    showNotification('Product updated successfully!', 'success');
                } catch (error) {
                    showNotification('Failed to update product: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        async function returnToStock(id) {
            if (!confirm('Are you sure you want to return this product to stock?')) return;

            try {
                showLoading(true);
                await ApiService.returnInventoryToStock(id);
                await initializeData();
                showNotification('Product returned to stock successfully!', 'success');
            } catch (error) {
                showNotification('Failed to return product to stock: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Table Updates
        function updateInventoryTable() {
            const table = document.getElementById('inventoryTable');
            if (!table) return;

            if (inventoryProducts.length === 0) {
                table.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No inventory products found</td></tr>';
                return;
            }

            table.innerHTML = '';

            inventoryProducts.forEach(product => {
                const finalPrice = product.salePrice * (1 - (product.discount || 0));
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name || 'Unknown'}</td>
                    <td>$${product.salePrice.toFixed(2)}</td>
                    <td>${((product.discount || 0) * 100).toFixed(1)}%</td>
                    <td>$${finalPrice.toFixed(2)}</td>
                    <td>${product.saleQuantity}</td>
                    <td>${product.category?.name || 'Unknown'}</td>
                    <td>
                        <button class="btn" onclick="editInventoryProduct(${product.id})" style="padding: 5px 10px; margin-right: 5px; width: auto;">Edit</button>
                        <button class="btn btn-danger" onclick="returnToStock(${product.id})" style="padding: 5px 10px; width: auto;">Return</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function updateStockTable() {
            const table = document.getElementById('stockTable');
            if (!table) return;

            if (stockProducts.length === 0) {
                table.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No stock products found</td></tr>';
                return;
            }

            table.innerHTML = '';

            stockProducts.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>$${product.basePrice.toFixed(2)}</td>
                    <td>${product.quantity}</td>
                    <td>${product.category?.name || 'Unknown'}</td>
                    <td>
                        <button class="btn" onclick="editStockProduct(${product.id})" style="padding: 5px 10px; margin-right: 5px; width: auto;">Edit</button>
                        <button class="btn btn-danger" onclick="deleteStockProduct(${product.id})" style="padding: 5px 10px; width: auto;">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function updateCategoryDropdowns() {
            const dropdowns = document.querySelectorAll('#stockCategory, #inventoryCategory');
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">Select category...</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        dropdown.appendChild(option);
                    });
                }
            });

            // Update stock product dropdown for inventory form
            const stockProductDropdown = document.getElementById('inventoryStockProduct');
            if (stockProductDropdown) {
                stockProductDropdown.innerHTML = '<option value="">Select a stock product...</option>';
                stockProducts.forEach(product => {
                    if (product.quantity > 0) {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (Available: ${product.quantity}) - $${product.basePrice}`;
                        stockProductDropdown.appendChild(option);
                    }
                });
            }
        }

        // Reports
        async function updateReports() {
            try {
                showLoading(true);

                // Try to get daily report, but handle failures gracefully
                let reportData = {};
                try {
                    reportData = await ApiService.getDailyReport();
                    console.log('Report data received:', reportData);
                } catch (error) {
                    console.warn('Failed to load daily report:', error);
                    showNotification('Unable to load reports data', 'error');
                    // Use default values
                    reportData = {
                        totalSales: 0,
                        transactionCount: 0,
                        topSellingProduct: '-',
                        lowStockCount: 0,
                        totalProfit: 0
                    };
                }

                // Update UI with data (or defaults)
                const elements = {
                    todaySales: document.getElementById('todaySales'),
                    totalTransactions: document.getElementById('totalTransactions'),
                    topProduct: document.getElementById('topProduct'),
                    lowStock: document.getElementById('lowStock'),
                    totalProfit: document.getElementById('totalProfit')
                };

                if (elements.todaySales) elements.todaySales.textContent = `$${(reportData.totalSales || 0).toFixed(2)}`;
                if (elements.totalTransactions) elements.totalTransactions.textContent = reportData.transactionCount || 0;
                if (elements.topProduct) elements.topProduct.textContent = reportData.topSellingProduct || '-';
                if (elements.lowStock) elements.lowStock.textContent = reportData.lowStockCount || 0;
                if (elements.totalProfit) elements.totalProfit.textContent = `$${(reportData.totalProfit || 0).toFixed(2)}`;

                updateTransactionTable();

            } catch (error) {
                console.error('Failed to load reports:', error);
                showNotification('Failed to load reports section', 'error');
            } finally {
                showLoading(false);
            }
        }
        function updateTransactionTable() {
            const transactionTable = document.getElementById('transactionTable');
            if (transactionTable && transactions.length > 0) {
                transactionTable.innerHTML = '';
                transactions.slice(-10).reverse().forEach(transaction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${transaction.time}</td>
                        <td>${transaction.items} items</td>
                        <td>$${transaction.total.toFixed(2)}</td>
                        <td>${transaction.paymentMethod}</td>
                    `;
                    transactionTable.appendChild(row);
                });
            } else if (transactionTable) {
                transactionTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No transactions found</td></tr>';
            }
        }

        // Settings
        function saveStoreSettings(event) {
            event.preventDefault();
            settings.storeName = document.getElementById('storeName').value;
            settings.storeAddress = document.getElementById('storeAddress').value;
            settings.storePhone = document.getElementById('storePhone').value;
            showNotification('Store settings saved!', 'success');
        }

        function updatePaymentSettings(event) {
            event.preventDefault();
            settings.taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            settings.currency = document.getElementById('currency').value;
            settings.lowStockAlert = parseInt(document.getElementById('lowStockAlert').value) || 10;
            showNotification('Payment settings updated!', 'success');
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Change calculation for checkout
            const amountReceived = document.getElementById('amountReceived');
            if (amountReceived) {
                amountReceived.addEventListener('input', function () {
                    const total = parseFloat(document.getElementById('modalTotal').textContent);
                    const received = parseFloat(this.value) || 0;
                    const change = Math.max(0, received - total);
                    document.getElementById('changeAmount').textContent = change.toFixed(2);
                });
            }

            // Stock product selection for inventory
            const stockProductSelect = document.getElementById('inventoryStockProduct');
            if (stockProductSelect) {
                stockProductSelect.addEventListener('change', function () {
                    const selectedProductId = parseInt(this.value);
                    const stockProduct = stockProducts.find(p => p.id === selectedProductId);

                    if (stockProduct) {
                        const quantityInput = document.getElementById('inventorySaleQuantity');
                        quantityInput.max = stockProduct.quantity;
                        quantityInput.placeholder = `Max: ${stockProduct.quantity}`;

                        const salePriceInput = document.getElementById('inventorySalePrice');
                        if (!salePriceInput.value) {
                            salePriceInput.value = (stockProduct.basePrice * 1.3).toFixed(2);
                        }
                    }
                });
            }
        }

        // Session Management
        function checkAuthState() {
            if (authToken) {
                console.log('Existing session found, initializing data...');
                initializeData().then(() => {
                    showTab('pos');
                    showNotification('Welcome back! Session restored.', 'success');
                }).catch(error => {
                    console.error('Failed to restore session:', error);
                    ApiService.logout();
                    showTab('login');
                    showNotification('Session expired. Please login again.', 'error');
                });
            } else {
                showTab('login');
            }
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Application starting...');

            // Update API URL display
            const apiUrlElement = document.getElementById('apiUrl');
            if (apiUrlElement) {
                apiUrlElement.textContent = API_CONFIG.baseURL;
            }

            // Set up event listeners
            setupEventListeners();

            // Check authentication state and initialize accordingly
            checkAuthState();

            // Test connection
            testConnection();

            console.log('Application initialized');
        });

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('checkoutModal');
            if (modal && event.target === modal) {
                closeModal();
            }
        }

        // Global error handling
        window.addEventListener('unhandledrejection', event => {
            console.error('Unhandled promise rejection:', event.reason);
            if (event.reason.message.includes('Authentication required')) {
                ApiService.logout();
                showTab('login');
                showNotification('Session expired. Please login again.', 'error');
            }
        });

        // Auto-logout on token expiration (optional)
        function startSessionTimer() {
            if (authToken && loginTime) {
                const sessionDuration = 8 * 60 * 60 * 1000; // 8 hours
                const loginTimestamp = new Date(loginTime).getTime();
                const currentTime = new Date().getTime();
                const timeRemaining = sessionDuration - (currentTime - loginTimestamp);

                if (timeRemaining <= 0) {
                    ApiService.logout();
                    showTab('login');
                    showNotification('Session expired. Please login again.', 'error');
                } else {
                    setTimeout(() => {
                        ApiService.logout();
                        showTab('login');
                        showNotification('Session expired due to inactivity.', 'error');
                    }, timeRemaining);
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey) {
                switch (event.key) {
                    case '1':
                        event.preventDefault();
                        if (authToken) showTab('pos');
                        break;
                    case '2':
                        event.preventDefault();
                        if (authToken) showTab('inventory');
                        break;
                    case '3':
                        event.preventDefault();
                        if (authToken) showTab('stock');
                        break;
                    case '4':
                        event.preventDefault();
                        if (authToken) showTab('reports');
                        break;
                    case '5':
                        event.preventDefault();
                        if (authToken) showTab('settings');
                        break;
                    case 'Enter':
                        event.preventDefault();
                        if (authToken && cart.length > 0) checkout();
                        break;
                }
            }
        });

        // Start session timer
        if (authToken) {
            startSessionTimer();
        }
    </script>
</body>

</html>